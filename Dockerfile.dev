# Development Dockerfile for honotreez
# Optimized for fast development with hot-reload

# Use specific Bun version (pinned, not latest)
FROM oven/bun:1-alpine AS base
WORKDIR /usr/src/app

# Install development dependencies
FROM base AS install
RUN mkdir -p /temp/dev
COPY package.json bun.lock /temp/dev/
RUN cd /temp/dev && bun install --frozen-lockfile

# Copy dependencies and application code
FROM base AS development
COPY --from=install /temp/dev/node_modules node_modules
COPY package.json tsconfig.json ./
COPY src ./src

# Create non-root user for security
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
RUN chown -R appuser:appgroup /usr/src/app

# Switch to non-root user
USER appuser

# Expose port
EXPOSE 3000

# Health check for development
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD bun run --bun -e "fetch('http://localhost:3000/api/healthcheck').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"

# Run with hot-reload
CMD ["bun", "run", "--hot", "src/index.ts"]
